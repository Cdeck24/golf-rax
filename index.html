<script type="text/babel">
  const { useState, useEffect, useMemo } = React;

  // Icons (same as you already use)
  const CalendarIcon = ({ size = 24, className = "" }) => (
    <svg
      className={className}
      xmlns="http://www.w3.org/2000/svg"
      width={size}
      height={size}
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
    >
      <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
      <line x1="16" y1="2" x2="16" y2="6" />
      <line x1="8" y1="2" x2="8" y2="6" />
      <line x1="3" y1="10" x2="21" y2="10" />
    </svg>
  );

  const TrophyIcon = ({ size = 24, className = "" }) => (
    <svg
      className={className}
      xmlns="http://www.w3.org/2000/svg"
      width={size}
      height={size}
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
    >
      <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" />
      <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
      <path d="M4 22h16" />
      <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" />
      <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" />
      <path d="M18 2H6v7a6 6 0 0 0 12 0V2z" />
    </svg>
  );

  const UploadIcon = ({ size = 24, className = "" }) => (
    <svg
      className={className}
      xmlns="http://www.w3.org/2000/svg"
      width={size}
      height={size}
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
    >
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
      <polyline points="17 8 12 3 7 8" />
      <line x1="12" y1="3" x2="12" y2="15" />
    </svg>
  );

  const CalendarXIcon = ({ size = 24, className = "" }) => (
    <svg
      className={className}
      xmlns="http://www.w3.org/2000/svg"
      width={size}
      height={size}
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
    >
      <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
      <line x1="16" y1="2" x2="16" y2="6" />
      <line x1="8" y1="2" x2="8" y2="6" />
      <line x1="3" y1="10" x2="21" y2="10" />
      <line x1="10" y1="14" x2="14" y2="18" />
      <line x1="14" y1="14" x2="10" y2="18" />
    </svg>
  );

  const SearchIcon = ({ size = 24, className = "" }) => (
    <svg
      className={className}
      xmlns="http://www.w3.org/2000/svg"
      width={size}
      height={size}
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
    >
      <circle cx="11" cy="11" r="8" />
      <line x1="21" y1="21" x2="16.65" y2="16.65" />
    </svg>
  );

  // Helpers
  const getMonthDay = (dateStr) => {
    if (!dateStr || typeof dateStr !== "string") return null;
    let m = dateStr.match(/^(\d{4})[-/.](\d{1,2})[-/.](\d{1,2})/);
    if (m) return { m: parseInt(m[2]), d: parseInt(m[3]) };

    m = dateStr.match(/^(\d{1,2})[-/.](\d{1,2})[-/.](\d{4})/);
    if (m) return { m: parseInt(m[1]), d: parseInt(m[2]) };

    const d = new Date(dateStr);
    if (!isNaN(d)) return { m: d.getMonth() + 1, d: d.getDate() };
    return null;
  };

  // Core: read player_config + player_earnings
  const normalizeEvents = (jsonData, sourceYear) => {
    let events = [];
    const golferMeta = {};

    // 1) Names: from player_config
    if (jsonData && jsonData.player_config) {
      const pc = jsonData.player_config;
      Object.keys(pc).forEach((key) => {
        const val = pc[key];
        if (
          val &&
          typeof val.first_name === "string" &&
          typeof val.last_name === "string"
        ) {
          const id = String(val.player_id ?? key);
          golferMeta[id] = {
            first_name: val.first_name,
            last_name: val.last_name,
          };
        }
      });
    }

    // 2) Earnings: from player_earnings (matches your big JSON) [file:14]
    if (jsonData && jsonData.player_earnings) {
      const pe = jsonData.player_earnings;
      Object.keys(pe).forEach((pid) => {
        const entry = pe[pid];
        if (!entry || !Array.isArray(entry.dates)) return;

        const golferId = String(pid);
        entry.dates.forEach((d) => {
          if (!d.date || d.earnings == null) return;
          const rax = Number(d.earnings);
          if (Number.isNaN(rax)) return;

          const year =
            sourceYear ||
            (typeof d.date === "string"
              ? parseInt(d.date.substring(0, 4))
              : null) ||
            new Date().getFullYear();

          events.push({
            date: d.date,
            year,
            golferId,
            rax,
          });
        });
      });
    }

    // 3) Optional: keep your old heuristics as fallback (omitted here to keep it clear)

    // 4) Attach names
    events = events.map((e) => {
      const meta = golferMeta[e.golferId];
      if (!meta) return e;
      return {
        ...e,
        first_name: meta.first_name,
        last_name: meta.last_name,
      };
    });

    return events;
  };

  // Rankings
  const RankingsView = ({ events }) => {
    const [search, setSearch] = useState("");
    const [activeOnly, setActiveOnly] = useState(false);

    const golfers = useMemo(() => {
      const map = {};
      events.forEach((e) => {
        if (!map[e.golferId]) {
          const fullName =
            e.first_name && e.last_name
              ? `${e.first_name} ${e.last_name}`
              : undefined;
          map[e.golferId] = {
            golferId: e.golferId,
            name: fullName,
            totalRax: 0,
            events: 0,
            lastYear: e.year,
          };
        }
        map[e.golferId].totalRax += e.rax;
        map[e.golferId].events += 1;
        if (e.year > map[e.golferId].lastYear) map[e.golferId].lastYear = e.year;

        if (e.first_name && e.last_name) {
          map[e.golferId].name = `${e.first_name} ${e.last_name}`;
        }
      });
      return Object.values(map);
    }, [events]);

    const filtered = useMemo(() => {
      return golfers
        .filter((g) => {
          if (!search) return true;
          const q = search.toLowerCase();
          const byName = g.name ? g.name.toLowerCase().includes(q) : false;
          return (
            byName || String(g.golferId).toLowerCase().includes(q)
          );
        })
        .filter((g) => !activeOnly || g.lastYear >= 2024)
        .sort((a, b) => b.totalRax - a.totalRax)
        .map((g, i) => ({ ...g, rank: i + 1 }));
    }, [golfers, search, activeOnly]);

    return (
      <div className="bg-white rounded-2xl border border-gray-200 shadow-sm p-4 md:p-6">
        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
          <h2 className="text-xl font-black text-gray-800">Golfer Rankings</h2>
          <div className="flex flex-col sm:flex-row gap-3 sm:items-center">
            <div className="relative">
              <SearchIcon className="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" />
              <input
                type="text"
                placeholder="Search golfers"
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                className="pl-8 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500"
              />
            </div>
            <label className="inline-flex items-center gap-2 text-sm cursor-pointer">
              <input
                type="checkbox"
                checked={activeOnly}
                onChange={(e) => setActiveOnly(e.target.checked)}
                className="rounded border-gray-300 text-green-600 focus:ring-green-500"
              />
              <span className="text-gray-700">Active Only</span>
            </label>
          </div>
        </div>

        <div className="overflow-x-auto">
          <table className="min-w-full text-sm">
            <thead>
              <tr className="border-b border-gray-200 text-xs uppercase text-gray-500">
                <th className="text-left py-2 px-2">Rank</th>
                <th className="text-left py-2 px-2">Golfer</th>
                <th className="text-right py-2 px-2">Rax (All Time)</th>
                <th className="text-right py-2 px-2">Events</th>
                <th className="text-right py-2 px-2">Last Year</th>
                <th className="text-right py-2 px-2"></th>
              </tr>
            </thead>
            <tbody>
              {filtered.map((g) => {
                const displayName =
                  g.name ||
                  (/^\d+$/.test(g.golferId)
                    ? `Golfer ID: ${g.golferId}`
                    : g.golferId);
                return (
                  <tr
                    key={g.golferId}
                    className="border-b border-gray-100 hover:bg-gray-50"
                  >
                    <td className="py-2 px-2 text-gray-500 font-mono">
                      {g.rank}
                    </td>
                    <td className="py-2 px-2 font-medium text-gray-800">
                      {displayName}
                    </td>
                    <td className="py-2 px-2 text-right font-semibold text-gray-800">
                      {g.totalRax.toLocaleString(undefined, {
                        maximumFractionDigits: 1,
                      })}
                    </td>
                    <td className="py-2 px-2 text-right text-gray-700">
                      {g.events}
                    </td>
                    <td className="py-2 px-2 text-right text-gray-700">
                      {g.lastYear}
                    </td>
                    <td className="py-2 px-2 text-right">
                      <button className="text-xs font-semibold text-green-700 hover:text-green-900">
                        Detail View
                      </button>
                    </td>
                  </tr>
                );
              })}
              {filtered.length === 0 && (
                <tr>
                  <td
                    colSpan={6}
                    className="py-6 text-center text-gray-500"
                  >
                    No golfers match your filters.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    );
  };

  // OTD View
  const OtdView = ({ events, month, day, setMonth, setDay, handleFiles }) => {
    const [innerMode, setInnerMode] = useState("investments");

    const otdEvents = useMemo(
      () =>
        events.filter((e) => {
          const md = getMonthDay(e.date);
          return md && md.m === month && md.d === day;
        }),
      [events, month, day]
    );

    const yearGroups = useMemo(() => {
      const groups = {};
      otdEvents.forEach((e) => {
        if (!groups[e.year]) groups[e.year] = { total: 0, golfers: {} };
        groups[e.year].total += e.rax;
        if (!groups[e.year].golfers[e.golferId]) {
          groups[e.year].golfers[e.golferId] = { total: 0, name: undefined };
        }
        groups[e.year].golfers[e.golferId].total += e.rax;
        if (e.first_name && e.last_name) {
          groups[e.year].golfers[e.golferId].name = `${e.first_name} ${e.last_name}`;
        }
      });
      return groups;
    }, [otdEvents]);

    const golferAggregates = useMemo(() => {
      const groups = {};
      otdEvents.forEach((e) => {
        if (!groups[e.golferId]) {
          groups[e.golferId] = { total: 0, years: {}, name: undefined };
        }
        groups[e.golferId].total += e.rax;
        groups[e.golferId].years[e.year] =
          (groups[e.golferId].years[e.year] || 0) + e.rax;
        if (e.first_name && e.last_name) {
          groups[e.golferId].name = `${e.first_name} ${e.last_name}`;
        }
      });
      return groups;
    }, [otdEvents]);

    const sortedYears = Object.keys(yearGroups).sort((a, b) => b - a);
    const grandTotal = otdEvents.reduce((sum, e) => sum + e.rax, 0);
    const sortedTopGolfers = Object.keys(golferAggregates).sort(
      (a, b) => golferAggregates[b].total - golferAggregates[a].total
    );

    const monthsList = [
      "January","February","March","April","May","June",
      "July","August","September","October","November","December",
    ];
    const daysInMonth = new Date(2024, month, 0).getDate();
    const dateTitle = new Date(2024, month - 1, day).toLocaleDateString(
      "en-US",
      { month: "long", day: "numeric" }
    );

    const displayNameFromAgg = (agg, id) =>
      agg[id].name ||
      (/^\d+$/.test(id) ? `Golfer ID: ${id}` : id);

    return (
      <div className="animate-fade-in">
        {/* Controls + upload */}
        <div className="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-8 bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
          <div className="flex gap-4 items-center flex-1">
            <div className="flex-1 max-w-[200px]">
              <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">
                Month
              </label>
              <select
                value={month}
                onChange={(e) => {
                  setMonth(parseInt(e.target.value));
                  setDay(1);
                }}
                className="w-full border-gray-300 rounded-lg p-2.5 bg-gray-50 border focus:ring-green-500 focus:border-green-500"
              >
                {monthsList.map((m, i) => (
                  <option key={i} value={i + 1}>
                    {m}
                  </option>
                ))}
              </select>
            </div>
            <div className="flex-1 max-w-[120px]">
              <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">
                Day
              </label>
              <select
                value={day}
                onChange={(e) => setDay(parseInt(e.target.value))}
                className="w-full border-gray-300 rounded-lg p-2.5 bg-gray-50 border focus:ring-green-500 focus:border-green-500"
              >
                {Array.from({ length: daysInMonth }, (_, i) => i + 1).map(
                  (d) => (
                    <option key={d} value={d}>
                      {d}
                    </option>
                  )
                )}
              </select>
            </div>
            <button
              onClick={() => {
                const now = new Date();
                setMonth(now.getMonth() + 1);
                setDay(now.getDate());
              }}
              className="mt-5 px-4 py-2.5 bg-green-100 text-green-800 rounded-lg hover:bg-green-200 font-medium transition-colors"
            >
              Today
            </button>
          </div>
          <div className="md:border-l md:border-gray-200 md:pl-6 pt-4 md:pt-0 border-t border-gray-100">
            <label className="cursor-pointer text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium inline-flex items-center gap-2 transition-colors">
              <UploadIcon size={16} /> Add More Files
              <input
                type="file"
                multiple
                accept=".json"
                className="hidden"
                onChange={handleFiles}
              />
            </label>
          </div>
        </div>

        {/* Grand total */}
        <div className="mb-8 p-8 bg-gradient-to-br from-green-600 to-green-800 text-white rounded-2xl shadow-lg flex justify-between items-center relative overflow-hidden">
          <div className="relative z-10">
            <h2 className="text-lg font-medium opacity-90 tracking-wide uppercase">
              All-Time OTD Earnings
            </h2>
            <div className="flex items-baseline gap-2 mt-1">
              <p className="text-5xl font-black">
                {grandTotal.toLocaleString(undefined, {
                  minimumFractionDigits: 0,
                  maximumFractionDigits: 1,
                })}
              </p>
              <span className="text-xl opacity-80 font-medium">Rax</span>
            </div>
            <p className="opacity-75 mt-2 text-sm">
              Historically achieved on {dateTitle}
            </p>
          </div>
          <TrophyIcon
            size={100}
            className="opacity-10 absolute right-4 top-1/2 transform -translate-y-1/2 rotate-12"
          />
        </div>

        {/* Mode toggle */}
        {otdEvents.length > 0 && (
          <div className="flex justify-center mb-6">
            <div className="flex bg-gray-200 p-1 rounded-xl inline-flex shadow-inner">
              <button
                onClick={() => setInnerMode("investments")}
                className={`px-6 py-2.5 rounded-lg font-bold text-sm transition-all ${
                  innerMode === "investments"
                    ? "bg-white text-green-700 shadow-sm"
                    : "text-gray-500 hover:text-gray-700"
                }`}
              >
                üèÜ Best Investments
              </button>
              <button
                onClick={() => setInnerMode("years")}
                className={`px-6 py-2.5 rounded-lg font-bold text-sm transition-all ${
                  innerMode === "years"
                    ? "bg-white text-green-700 shadow-sm"
                    : "text-gray-500 hover:text-gray-700"
                }`}
              >
                üìÖ Year-by-Year
              </button>
            </div>
          </div>
        )}

        {/* Content */}
        {sortedYears.length === 0 ? (
          <div className="text-center p-12 bg-white rounded-2xl border border-gray-200 text-gray-500">
            <CalendarXIcon size={56} className="mx-auto mb-4 opacity-20" />
            <h3 className="text-xl font-bold text-gray-700">
              No events found
            </h3>
            <p className="mt-2">
              There are no recorded earnings on {dateTitle}.
            </p>
          </div>
        ) : (
          <div className="space-y-6">
            {innerMode === "investments" && (
              <div className="bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm">
                <div className="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                  <h3 className="text-xl font-black text-gray-800">
                    Top Earners Across All Years
                  </h3>
                </div>
                <ul className="divide-y divide-gray-100">
                  {sortedTopGolfers.map((gId, index) => {
                    const data = golferAggregates[gId];
                    const activeYears = Object.keys(data.years).sort(
                      (a, b) => b - a
                    );
                    const displayName =
                      data.name ||
                      (/^\d+$/.test(gId)
                        ? `Golfer ID: ${gId}`
                        : gId);
                    return (
                      <li
                        key={gId}
                        className="px-6 py-4 flex flex-col sm:flex-row sm:justify-between sm:items-center hover:bg-gray-50 transition-colors gap-3"
                      >
                        <div className="flex items-start gap-3">
                          <span className="text-gray-400 font-mono text-sm w-4 mt-1">
                            {index + 1}.
                          </span>
                          <div>
                            <div className="font-bold text-gray-800 text-lg">
                              {displayName}
                            </div>
                            <div className="text-xs text-gray-500 mt-1 font-medium bg-gray-200 inline-block px-2 py-0.5 rounded">
                              {activeYears.length}{" "}
                              {activeYears.length === 1 ? "Year" : "Years"}:{" "}
                              {activeYears.join(", ")}
                            </div>
                          </div>
                        </div>
                        <div className="sm:text-right ml-7 sm:ml-0">
                          <div className="text-green-700 font-black text-xl">
                            {data.total.toLocaleString(undefined, {
                              minimumFractionDigits: 0,
                              maximumFractionDigits: 1,
                            })}{" "}
                            <span className="text-sm font-semibold opacity-75">
                              Rax
                            </span>
                          </div>
                        </div>
                      </li>
                    );
                  })}
                </ul>
              </div>
            )}

            {innerMode === "years" &&
              sortedYears.map((year) => {
                const data = yearGroups[year];
                const sortedGolfers = Object.keys(data.golfers).sort(
                  (a, b) =>
                    data.golfers[b].total - data.golfers[a].total
                );
                const maxRax = Math.max(
                  ...Object.values(data.golfers).map((g) => g.total)
                );
                return (
                  <div
                    key={year}
                    className="bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm"
                  >
                    <div className="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                      <h3 className="text-xl font-black text-gray-800">
                        {year}
                      </h3>
                      <span className="font-bold text-green-700 bg-green-100 px-3 py-1 rounded-full text-sm">
                        {data.total.toLocaleString(undefined, {
                          minimumFractionDigits: 0,
                          maximumFractionDigits: 1,
                        })}{" "}
                        Rax
                      </span>
                    </div>
                    <ul className="divide-y divide-gray-100">
                      {sortedGolfers.map((gId, index) => {
                        const gData = data.golfers[gId];
                        const displayName =
                          gData.name ||
                          (/^\d+$/.test(gId)
                            ? `Golfer ID: ${gId}`
                            : gId);
                        return (
                          <li
                            key={gId}
                            className="px-6 py-4 flex justify-between items-center hover:bg-gray-50 transition-colors"
                          >
                            <div className="flex items-center gap-3">
                              <span className="text-gray-400 font-mono text-sm w-4">
                                {index + 1}.
                              </span>
                              <span className="font-medium text-gray-800 text-lg">
                                {displayName}
                              </span>
                              {gData.total === maxRax && (
                                <span className="text-[10px] uppercase tracking-wider bg-yellow-100 text-yellow-800 px-2.5 py-1 rounded-full font-bold shadow-sm">
                                  Top Earner
                                </span>
                              )}
                            </div>
                            <span className="text-gray-600 font-semibold text-lg">
                              {gData.total.toLocaleString(undefined, {
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 1,
                              })}
                            </span>
                          </li>
                        );
                      })}
                    </ul>
                  </div>
                );
              })}
          </div>
        )}
      </div>
    );
  };

  // Who to Buy
  const WhoToBuyView = ({ events }) => {
    const golfers = useMemo(() => {
      const map = {};
      events.forEach((e) => {
        if (!map[e.golferId]) {
          const name =
            e.first_name && e.last_name
              ? `${e.first_name} ${e.last_name}`
              : undefined;
          map[e.golferId] = {
            golferId: e.golferId,
            name,
            totalRax: 0,
            events: 0,
          };
        }
        map[e.golferId].totalRax += e.rax;
        map[e.golferId].events += 1;
        if (e.first_name && e.last_name) {
          map[e.golferId].name = `${e.first_name} ${e.last_name}`;
        }
      });
      return Object.values(map)
        .sort((a, b) => b.totalRax - a.totalRax)
        .slice(0, 10);
    }, [events]);

    return (
      <div className="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
        <h2 className="text-xl font-black text-gray-800 mb-4">Who to Buy</h2>
        <p className="text-sm text-gray-600 mb-4">
          Top 10 golfers by total OTD Rax across all years.
        </p>
        <ul className="divide-y divide-gray-100">
          {golfers.map((g, i) => {
            const displayName =
              g.name ||
              (/^\d+$/.test(g.golferId)
                ? `Golfer ID: ${g.golferId}`
                : g.golferId);
            return (
              <li
                key={g.golferId}
                className="py-3 flex justify-between items-center"
              >
                <div className="flex items-center gap-3">
                  <span className="text-gray-400 font-mono text-sm w-4">
                    {i + 1}.
                  </span>
                  <span className="font-medium text-gray-800">
                    {displayName}
                  </span>
                </div>
                <span className="font-semibold text-green-700">
                  {g.totalRax.toLocaleString(undefined, {
                    maximumFractionDigits: 1,
                  })}{" "}
                  Rax
                </span>
              </li>
            );
          })}
        </ul>
      </div>
    );
  };

  // Main App
  const App = () => {
    const [events, setEvents] = useState([]);
    const [dataLoaded, setDataLoaded] = useState(false);
    const [isLoading, setIsLoading] = useState(true);
    const [month, setMonth] = useState(new Date().getMonth() + 1);
    const [day, setDay] = useState(new Date().getDate());
    const [viewMode, setViewMode] = useState("rankings");

    // Auto-load golf-otd JSON files if deployed with them
    useEffect(() => {
      const attemptAutoFetch = async () => {
        setIsLoading(true);
        let localEvents = [];
        let loadedAny = false;

        try {
          for (let y = 2014; y <= 2025; y++) {
            try {
              const res = await fetch(`./golf-otd/${y}-golf-data.json`);
              if (res.ok) {
                const json = await res.json();
                localEvents = localEvents.concat(normalizeEvents(json, y));
                loadedAny = true;
              }
            } catch {
              // ignore missing file
            }
          }
        } catch {
          // ignore
        }

        if (loadedAny && localEvents.length > 0) {
          setEvents(localEvents);
          setDataLoaded(true);
        }
        setIsLoading(false);
      };

      attemptAutoFetch();
    }, []);

    // Manual upload
    const handleFiles = async (e) => {
      setIsLoading(true);
      const files = Array.from(e.target.files);
      let newEvents = [];

      for (let file of files) {
        if (!file.name.toLowerCase().endsWith(".json")) continue;
        try {
          const json = JSON.parse(await file.text());
          const yearMatch = file.name.match(/(\d{4})/);
          const year = yearMatch ? parseInt(yearMatch[1]) : null;
          newEvents = newEvents.concat(normalizeEvents(json, year));
        } catch {
          console.error("Error parsing", file.name);
        }
      }

      setEvents((prev) => [...prev, ...newEvents]);
      setDataLoaded(true);
      setIsLoading(false);
    };

    return (
      <div className="pb-12">
        <header className="bg-green-800 text-white p-6 shadow-md">
          <div className="max-w-5xl mx-auto flex justify-between items-center">
            <h1 className="text-2xl font-bold flex items-center gap-2">
              <CalendarIcon /> Golf Rax Tracker
            </h1>
            {dataLoaded && (
              <div className="text-sm bg-green-900 px-3 py-1 rounded-full opacity-80 border border-green-700">
                {events.length.toLocaleString()} records loaded
              </div>
            )}
          </div>
        </header>

        <main className="max-w-5xl mx-auto mt-8 px-4">
          {/* nav */}
          <div className="flex justify-center mb-6">
            <div className="flex bg-gray-200 p-1 rounded-xl inline-flex shadow-inner">
              <button
                onClick={() => setViewMode("rankings")}
                className={`px-6 py-2.5 rounded-lg font-bold text-sm transition-all ${
                  viewMode === "rankings"
                    ? "bg-white text-green-700 shadow-sm"
                    : "text-gray-500 hover:text-gray-700"
                }`}
              >
                Rankings
              </button>
              <button
                onClick={() => setViewMode("otd")}
                className={`px-6 py-2.5 rounded-lg font-bold text-sm transition-all ${
                  viewMode === "otd"
                    ? "bg-white text-green-700 shadow-sm"
                    : "text-gray-500 hover:text-gray-700"
                }`}
              >
                OTD View
              </button>
              <button
                onClick={() => setViewMode("whoToBuy")}
                className={`px-6 py-2.5 rounded-lg font-bold text-sm transition-all ${
                  viewMode === "whoToBuy"
                    ? "bg-white text-green-700 shadow-sm"
                    : "text-gray-500 hover:text-gray-700"
                }`}
              >
                Who to Buy
              </button>
            </div>
          </div>

          {isLoading && !dataLoaded ? (
            <div className="text-center p-12 text-gray-500 animate-pulse">
              <SearchIcon
                size={48}
                className="mx-auto mb-4 opacity-50 animate-spin"
              />
              <p className="text-lg">
                Analyzing local repository data...
              </p>
            </div>
          ) : !dataLoaded ? (
            <div className="bg-white p-10 rounded-2xl shadow-sm border border-gray-200 text-center">
              <div className="w-16 h-16 bg-green-100 text-green-700 rounded-full flex items-center justify-center mx-auto mb-4">
                <UploadIcon size={32} />
              </div>
              <h2 className="text-2xl font-bold mb-2 text-gray-800">
                Load Rax Data
              </h2>
              <p className="text-gray-600 mb-8 max-w-md mx-auto">
                Automatic data fetching may be blocked. Select your{" "}
                <b>golf-otd</b> JSON files to begin.
              </p>

              <label className="cursor-pointer bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-xl font-medium inline-flex items-center gap-3 shadow-sm transition-all hover:scale-105">
                <UploadIcon />
                Select Files
                <input
                  type="file"
                  multiple
                  accept=".json"
                  className="hidden"
                  onChange={handleFiles}
                />
              </label>
            </div>
          ) : (
            <>
              {viewMode === "rankings" && <RankingsView events={events} />}
              {viewMode === "otd" && (
                <OtdView
                  events={events}
                  month={month}
                  day={day}
                  setMonth={setMonth}
                  setDay={setDay}
                  handleFiles={handleFiles}
                />
              )}
              {viewMode === "whoToBuy" && <WhoToBuyView events={events} />}
            </>
          )}
        </main>
      </div>
    );
  };

  const root = ReactDOM.createRoot(document.getElementById("root"));
  root.render(<App />);
</script>
