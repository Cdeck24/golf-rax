<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Yearly Rax Tracker</title>
    <!-- React and Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- SVGs & Icons ---
        const CalendarIcon = ({size=24, className=""}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>;
        const TrophyIcon = ({size=24, className=""}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2z"></path></svg>;
        const UploadIcon = ({size=24, className=""}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>;
        const CalendarXIcon = ({size=24, className=""}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line><line x1="10" y1="14" x2="14" y2="18"></line><line x1="14" y1="14" x2="10" y2="18"></line></svg>;
        const SearchIcon = ({size=24, className=""}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>;

        // --- Data Parsers ---
        const normalizeEvents = (jsonData, sourceYear) => {
            let events = [];
            
            const checkIsDate = (str) => {
                if(typeof str !== 'string') return false;
                return !!str.match(/^(\d{4}[-/.]\d{1,2}[-/.]\d{1,2})|(\d{1,2}[-/.]\d{1,2}[-/.]\d{4})/);
            };
            
            // Heuristic 1: Object mapping ID/Name -> Date -> Rax
            if (typeof jsonData === 'object' && !Array.isArray(jsonData)) {
                let isNestedMap = true;
                let hasDates = false;
                for (let key in jsonData) {
                    if (jsonData[key] && typeof jsonData[key] === 'object' && !Array.isArray(jsonData[key])) {
                        for (let innerKey in jsonData[key]) {
                            if (checkIsDate(innerKey)) hasDates = true;
                            break;
                        }
                    } else { isNestedMap = false; break; }
                }
                
                if (isNestedMap && hasDates) {
                    for (let golferId in jsonData) {
                        for (let dateStr in jsonData[golferId]) {
                            const raxVal = jsonData[golferId][dateStr];
                            if (typeof raxVal === 'number' || (typeof raxVal === 'string' && !isNaN(parseFloat(raxVal)))) {
                                events.push({
                                    date: dateStr,
                                    year: sourceYear || parseInt(dateStr.substring(0, 4)) || new Date().getFullYear(),
                                    golferId: golferId,
                                    golferName: /^\d+$/.test(golferId) ? null : golferId, // Extract name if key isn't numeric
                                    rax: parseFloat(raxVal)
                                });
                            }
                        }
                    }
                    return events;
                }
            }
            
            // Heuristic 2: Object mapping Date -> ID/Name -> Rax
            if (typeof jsonData === 'object' && !Array.isArray(jsonData)) {
                let isDateMap = true;
                let validDateFound = false;
                for (let key in jsonData) {
                    if (checkIsDate(key)) validDateFound = true;
                    if (typeof jsonData[key] !== 'object' || Array.isArray(jsonData[key])) isDateMap = false;
                }
                if (isDateMap && validDateFound) {
                    for (let dateStr in jsonData) {
                        for (let golferId in jsonData[dateStr]) {
                            const raxVal = jsonData[dateStr][golferId];
                            if (typeof raxVal === 'number' || !isNaN(parseFloat(raxVal))) {
                                events.push({
                                    date: dateStr,
                                    year: sourceYear || parseInt(dateStr.substring(0, 4)) || new Date().getFullYear(),
                                    golferId: golferId,
                                    golferName: /^\d+$/.test(golferId) ? null : golferId,
                                    rax: parseFloat(raxVal)
                                });
                            }
                        }
                    }
                    return events;
                }
            }
            
            // Heuristic 3: Array of objects or flat mapping
            let flatArr = [];
            const flattenToArr = (obj) => {
                if (Array.isArray(obj)) obj.forEach(flattenToArr);
                else if (obj && typeof obj === 'object') {
                    let hasDateOrYear = false, hasRax = false;
                    for(let key in obj) {
                       if(key.toLowerCase().match(/date|time|year/)) hasDateOrYear = true;
                       if(key.toLowerCase().match(/rax|earn|rating|value|score/)) hasRax = true;
                    }
                    if(hasDateOrYear && hasRax) flatArr.push(obj);
                    else for(let key in obj) flattenToArr(obj[key]);
                }
            }
            flattenToArr(jsonData);
            
            if (flatArr.length > 0) {
                flatArr.forEach(item => {
                    const keys = Object.keys(item);
                    const dateKey = keys.find(k => k.toLowerCase().match(/date|time/));
                    const yearKey = keys.find(k => k.toLowerCase().match(/year/));
                    const raxKey = keys.find(k => k.toLowerCase().match(/rax|earn|rating|value|score/));
                    
                    // Search for name or ID keys
                    const nameKey = keys.find(k => k.toLowerCase().match(/name|player|golfer/) && !k.toLowerCase().match(/id/));
                    const idKey = keys.find(k => k.toLowerCase().match(/id/));
                    
                    if ((dateKey || yearKey || sourceYear) && raxKey) {
                        const dateStr = dateKey ? String(item[dateKey]) : null;
                        const itemYear = yearKey ? parseInt(item[yearKey]) : (dateStr ? parseInt(String(dateStr).substring(0,4)) : sourceYear);
                        
                        let gId = idKey ? String(item[idKey]) : 'Unknown';
                        let gName = nameKey ? String(item[nameKey]) : null;
                        
                        // Fallback to name if ID is unknown
                        if (gName && gId === 'Unknown') gId = gName;
                        
                        events.push({
                            date: dateStr || `${itemYear}-01-01`,
                            year: itemYear || sourceYear || new Date().getFullYear(),
                            golferId: gId,
                            golferName: gName,
                            rax: parseFloat(item[raxKey]) || 0
                        });
                    }
                });
                if (events.length > 0) return events;
            }

            // Heuristic 4 (Final Fallback): Deep scan for any number mapped to a date
            const deepScan = (obj, parentKey) => {
                if (!obj || typeof obj !== 'object') return;
                for (let key in obj) {
                    const val = obj[key];
                    if (typeof val === 'number' && checkIsDate(key)) {
                        events.push({
                            date: key,
                            year: sourceYear || parseInt(key.substring(0, 4)),
                            golferId: parentKey,
                            golferName: /^\d+$/.test(parentKey) ? null : parentKey,
                            rax: val
                        });
                    } else if (typeof val === 'object') {
                        deepScan(val, isNaN(key) ? key : parentKey);
                    }
                }
            };
            deepScan(jsonData, 'Unknown');
            
            return events;
        };

        // --- Main App Component ---
        const App = () => {
            const [events, setEvents] = useState([]);
            const [dataLoaded, setDataLoaded] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [viewMode, setViewMode] = useState('investments');

            useEffect(() => {
                const attemptAutoFetch = async () => {
                    setIsLoading(true);
                    let loadedAny = false;
                    let localEvents = [];

                    try {
                        for (let y = 2014; y <= 2025; y++) {
                            try {
                                const jRes = await fetch(`./golf-otd/${y}-golf-data.json`);
                                if (jRes.ok) {
                                    localEvents = localEvents.concat(normalizeEvents(await jRes.json(), y));
                                    loadedAny = true;
                                }
                            } catch (e) { /* Skip missing files silently */ }
                        }
                    } catch (e) {
                        // Network error or local file block (CORS)
                        console.log("Auto-fetch blocked or failed, waiting for user upload.");
                    }

                    if (loadedAny && localEvents.length > 0) {
                        setEvents(localEvents);
                        setDataLoaded(true);
                    }
                    setIsLoading(false);
                };

                attemptAutoFetch();
            }, []);

            const handleFiles = async (e) => {
                setIsLoading(true);
                const files = Array.from(e.target.files);
                let newEvents = [];
                
                for (let file of files) {
                    if (file.name.toLowerCase().endsWith('.json')) {
                        try {
                            const json = JSON.parse(await file.text());
                            const yearMatch = file.name.match(/(\d{4})/);
                            const year = yearMatch ? parseInt(yearMatch[1]) : null;
                            newEvents = newEvents.concat(normalizeEvents(json, year));
                        } catch(err) { console.error("Error parsing", file.name) }
                    }
                }
                
                setEvents(prev => [...prev, ...newEvents]);
                setDataLoaded(true);
                setIsLoading(false);
            };

            // Extract Name Mapping intelligently across all events
            const golferNameMap = useMemo(() => {
                const map = {};
                events.forEach(e => {
                    if (e.golferName && !/^\d+$/.test(e.golferName)) {
                        map[e.golferId] = e.golferName;
                    }
                });
                return map;
            }, [events]);

            const getDisplayName = (gId) => {
                if (golferNameMap[gId]) return golferNameMap[gId];
                return /^\d+$/.test(gId) ? `Golfer ID: ${gId}` : gId;
            };

            // Aggregate data by year
            const yearGroups = useMemo(() => {
                const groups = {};
                events.forEach(e => {
                    if (!groups[e.year]) groups[e.year] = { total: 0, golfers: {} };
                    groups[e.year].total += e.rax;
                    if (!groups[e.year].golfers[e.golferId]) groups[e.year].golfers[e.golferId] = 0;
                    groups[e.year].golfers[e.golferId] += e.rax;
                });
                return groups;
            }, [events]);
            
            const sortedYears = Object.keys(yearGroups).sort((a,b) => b - a);
            const grandTotal = events.reduce((sum, e) => sum + e.rax, 0);

            // Aggregate data globally for "Best Investments"
            const golferAggregates = useMemo(() => {
                const groups = {};
                events.forEach(e => {
                    if (!groups[e.golferId]) groups[e.golferId] = { total: 0, years: {} };
                    groups[e.golferId].total += e.rax;
                    groups[e.golferId].years[e.year] = (groups[e.golferId].years[e.year] || 0) + e.rax;
                });
                return groups;
            }, [events]);
            
            const sortedTopGolfers = Object.keys(golferAggregates).sort((a,b) => golferAggregates[b].total - golferAggregates[a].total);

            return (
                <div className="pb-12">
                    <header className="bg-green-800 text-white p-6 shadow-md">
                        <div className="max-w-4xl mx-auto flex justify-between items-center">
                            <h1 className="text-2xl font-bold flex items-center gap-2">
                                <CalendarIcon /> Golf Yearly Rax Tracker
                            </h1>
                            {dataLoaded && (
                                <div className="text-sm bg-green-900 px-3 py-1 rounded-full opacity-80 border border-green-700">
                                    {events.length.toLocaleString()} records loaded
                                </div>
                            )}
                        </div>
                    </header>
                    
                    <main className="max-w-4xl mx-auto mt-8 px-4">
                        {isLoading && !dataLoaded ? (
                            <div className="text-center p-12 text-gray-500 animate-pulse">
                                <SearchIcon size={48} className="mx-auto mb-4 opacity-50 animate-spin" />
                                <p className="text-lg">Analyzing local repository data...</p>
                            </div>
                        ) : !dataLoaded ? (
                            <div className="bg-white p-10 rounded-2xl shadow-sm border border-gray-200 text-center">
                                <div className="w-16 h-16 bg-green-100 text-green-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <UploadIcon size={32} />
                                </div>
                                <h2 className="text-2xl font-bold mb-2 text-gray-800">Load Rax Data</h2>
                                <p className="text-gray-600 mb-8 max-w-md mx-auto">
                                    Automatic data fetching failed (likely due to local file security). Please manually select the contents of your <b>golf-otd</b> folder to begin.
                                </p>
                                
                                <label className="cursor-pointer bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-xl font-medium inline-flex items-center gap-3 shadow-sm transition-all hover:scale-105">
                                    <UploadIcon />
                                    Select Folder/Files
                                    <input type="file" multiple accept=".json" className="hidden" onChange={handleFiles} />
                                </label>
                            </div>
                        ) : (
                            <div className="animate-fade-in">
                                {/* Dashboard Controls */}
                                <div className="flex justify-end mb-8 bg-white p-4 rounded-2xl shadow-sm border border-gray-200">
                                    <label className="cursor-pointer text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium inline-flex items-center gap-2 transition-colors">
                                        <UploadIcon size={16} /> Load Local Data
                                        <input type="file" multiple accept=".json" className="hidden" onChange={handleFiles} />
                                    </label>
                                </div>

                                {/* Grand Total Header */}
                                <div className="mb-8 p-8 bg-gradient-to-br from-green-600 to-green-800 text-white rounded-2xl shadow-lg flex justify-between items-center relative overflow-hidden">
                                    <div className="relative z-10">
                                        <h2 className="text-lg font-medium opacity-90 tracking-wide uppercase">All-Time Total Earnings</h2>
                                        <div className="flex items-baseline gap-2 mt-1">
                                            <p className="text-5xl font-black">{grandTotal.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 1 })}</p>
                                            <span className="text-xl opacity-80 font-medium">Rax</span>
                                        </div>
                                        <p className="opacity-75 mt-2 text-sm">Combined total across all recorded years</p>
                                    </div>
                                    <TrophyIcon size={100} className="opacity-10 absolute right-4 top-1/2 transform -translate-y-1/2 rotate-12" />
                                </div>

                                {/* View Mode Toggles */}
                                {events.length > 0 && (
                                    <div className="flex justify-center mb-6">
                                        <div className="flex bg-gray-200 p-1 rounded-xl inline-flex shadow-inner">
                                            <button 
                                                onClick={() => setViewMode('investments')}
                                                className={`px-6 py-2.5 rounded-lg font-bold text-sm transition-all ${viewMode === 'investments' ? 'bg-white text-green-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>
                                                üèÜ Best Investments
                                            </button>
                                            <button 
                                                onClick={() => setViewMode('years')}
                                                className={`px-6 py-2.5 rounded-lg font-bold text-sm transition-all ${viewMode === 'years' ? 'bg-white text-green-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>
                                                üìÖ Year-by-Year Breakdown
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {/* Results Rendering */}
                                {sortedYears.length === 0 ? (
                                    <div className="text-center p-12 bg-white rounded-2xl border border-gray-200 text-gray-500">
                                        <CalendarXIcon size={56} className="mx-auto mb-4 opacity-20" />
                                        <h3 className="text-xl font-bold text-gray-700">No events found</h3>
                                        <p className="mt-2">There are no recorded earnings loaded yet.</p>
                                    </div>
                                ) : (
                                    <div className="space-y-6">
                                        {viewMode === 'investments' && (
                                            <div className="bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm transition-shadow hover:shadow-md">
                                                <div className="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                                                    <h3 className="text-xl font-black text-gray-800">Top Earners Across All Years</h3>
                                                </div>
                                                <ul className="divide-y divide-gray-100">
                                                    {sortedTopGolfers.map((gId, index) => {
                                                        const data = golferAggregates[gId];
                                                        const activeYears = Object.keys(data.years).sort((a,b) => b-a);
                                                        return (
                                                            <li key={gId} className="px-6 py-4 flex flex-col sm:flex-row sm:justify-between sm:items-center hover:bg-gray-50 transition-colors gap-3">
                                                                <div className="flex items-start gap-3">
                                                                    <span className="text-gray-400 font-mono text-sm w-4 mt-1">{index + 1}.</span>
                                                                    <div>
                                                                        <div className="font-bold text-gray-800 text-lg">
                                                                            {getDisplayName(gId)}
                                                                        </div>
                                                                        <div className="text-xs text-gray-500 mt-1 font-medium bg-gray-200 inline-block px-2 py-0.5 rounded">
                                                                            {activeYears.length} {activeYears.length === 1 ? 'Year' : 'Years'}: {activeYears.join(', ')}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div className="sm:text-right ml-7 sm:ml-0">
                                                                    <div className="text-green-700 font-black text-xl">
                                                                        {data.total.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 1 })} <span className="text-sm font-semibold opacity-75">Rax</span>
                                                                    </div>
                                                                </div>
                                                            </li>
                                                        );
                                                    })}
                                                </ul>
                                            </div>
                                        )}

                                        {viewMode === 'years' && sortedYears.map(year => {
                                            const data = yearGroups[year];
                                            const sortedGolfers = Object.keys(data.golfers).sort((a,b) => data.golfers[b] - data.golfers[a]);
                                            const maxRax = Math.max(...Object.values(data.golfers));
                                            
                                            return (
                                                <div key={year} className="bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm transition-shadow hover:shadow-md">
                                                    <div className="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                                                        <h3 className="text-xl font-black text-gray-800">{year}</h3>
                                                        <span className="font-bold text-green-700 bg-green-100 px-3 py-1 rounded-full text-sm">
                                                            {data.total.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 1 })} Rax
                                                        </span>
                                                    </div>
                                                    <ul className="divide-y divide-gray-100">
                                                        {sortedGolfers.map((gId, index) => (
                                                            <li key={gId} className="px-6 py-4 flex justify-between items-center hover:bg-gray-50 transition-colors">
                                                                <div className="flex items-center gap-3">
                                                                    <span className="text-gray-400 font-mono text-sm w-4">{index + 1}.</span>
                                                                    <span className="font-medium text-gray-800 text-lg">
                                                                        {getDisplayName(gId)}
                                                                    </span>
                                                                    {data.golfers[gId] === maxRax && (
                                                                        <span className="text-[10px] uppercase tracking-wider bg-yellow-100 text-yellow-800 px-2.5 py-1 rounded-full font-bold shadow-sm">
                                                                            Top Earner
                                                                        </span>
                                                                    )}
                                                                </div>
                                                                <span className="text-gray-600 font-semibold text-lg">
                                                                    {data.golfers[gId].toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 1 })}
                                                                </span>
                                                            </li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
