<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Yearly Rax Tracker</title>
    <!-- React and Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        /* Custom scrollbar for webkit */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4B5563; }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen relative selection:bg-emerald-500/30">
    
    <!-- Ambient Background Lighting -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
        <div class="absolute -top-[20%] -left-[10%] w-[50%] h-[50%] rounded-full bg-emerald-900/20 blur-[150px]"></div>
        <div class="absolute top-[40%] -right-[10%] w-[40%] h-[60%] rounded-full bg-blue-900/10 blur-[150px]"></div>
    </div>

    <div id="root" class="relative z-10"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- SVGs & Icons ---
        const CalendarIcon = ({size=24, className=""}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>;
        const UploadIcon = ({size=24, className=""}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>;
        const CalendarXIcon = ({size=24, className=""}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line><line x1="10" y1="14" x2="14" y2="18"></line><line x1="14" y1="14" x2="10" y2="18"></line></svg>;
        const SearchIcon = ({size=24, className=""}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>;

        // --- Data Parsers ---
        const normalizeEvents = (jsonData, sourceYear) => {
            let events = [];
            let localNames = {}; 
            
            // Pass 1: Extract all golfer names globally
            const findNames = (obj) => {
                if (!obj || typeof obj !== 'object') return;
                
                // Check if the current object itself is a player
                if (obj.first_name || obj.last_name) {
                    const name = `${obj.first_name || ''} ${obj.last_name || ''}`.trim();
                    if (name && obj.player_id) localNames[String(obj.player_id)] = name;
                }

                for (let key in obj) {
                    const child = obj[key];
                    if (child && typeof child === 'object') {
                        if (child.first_name || child.last_name) {
                            const name = `${child.first_name || ''} ${child.last_name || ''}`.trim();
                            if (name) {
                                localNames[key] = name; // Map the parent key
                                if (child.player_id) localNames[String(child.player_id)] = name; // Map the explicit player ID
                            }
                        }
                        findNames(child);
                    }
                }
            };
            findNames(jsonData);

            // Pass 2: Extract all events recursively
            const findEvents = (obj, potentialPlayerId) => {
                if (!obj || typeof obj !== 'object') return;

                const dateKey = Object.keys(obj).find(k => /^(date|time)$/i.test(k));
                const raxKey = Object.keys(obj).find(k => /^(earnings|rax|score)$/i.test(k));

                // Is this object an event? (Must have date and earnings/rax)
                if (dateKey && raxKey) {
                    const rax = obj[raxKey];
                    const gId = String(obj.player_id || obj.Player_ID || potentialPlayerId);
                    
                    if (typeof obj[dateKey] === 'string' && obj[dateKey].trim() !== '') {
                        const dateStr = String(obj[dateKey]);
                        let extractedYear = null;
                        
                        // Extract year directly from the date string to prevent filename overrides
                        const yMatch = dateStr.match(/\b(20\d{2})\b/);
                        if (yMatch) extractedYear = parseInt(yMatch[1]);
                        
                        events.push({
                            date: dateStr,
                            year: extractedYear || sourceYear || new Date().getFullYear(),
                            golferId: gId,
                            rax: parseFloat(rax) || 0
                        });
                    }
                    return;
                }

                // Not an event, traverse deeper
                for (let key in obj) {
                    // Skip metadata keys to avoid deep scanning flat info
                    if (/^(first_name|last_name|player_id|total_earnings)$/i.test(key)) continue;
                    
                    const child = obj[key];
                    if (child && typeof child === 'object') {
                        let nextId = potentialPlayerId;
                        
                        const childDateKey = Object.keys(child).find(k => /^(date|time)$/i.test(k));
                        const childRaxKey = Object.keys(child).find(k => /^(earnings|rax|score)$/i.test(k));

                        // Heuristic: If the child is an event itself, the container ID remains the same.
                        // If the child is NOT an event, the current key is likely the Golfer ID container.
                        if (childDateKey && childRaxKey) {
                            nextId = potentialPlayerId;
                        } else if (!Array.isArray(obj)) {
                            nextId = key;
                        }
                        
                        findEvents(child, nextId);
                    }
                }
            };
            
            findEvents(jsonData, "Unknown");
            return { events, names: localNames };
        };

        // --- Main App Component ---
        const App = () => {
            const [events, setEvents] = useState([]);
            const [golferNames, setGolferNames] = useState({});
            const [dataLoaded, setDataLoaded] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [viewMode, setViewMode] = useState('investments');

            // --- Deduplication Helper ---
            const deduplicateEvents = (eventList) => {
                const map = new Map();
                eventList.forEach(e => {
                    const key = `dedupe_${e.golferId}_${e.year}_${e.date}_${e.rax}`;
                    map.set(key, e);
                });
                return Array.from(map.values());
            };

            useEffect(() => {
                const attemptAutoFetch = async () => {
                    setIsLoading(true);
                    let loadedAny = false;
                    let allEvents = [];
                    let allNames = {};

                    try {
                        for (let y = 2014; y <= 2025; y++) {
                            try {
                                const jRes = await fetch(`/golf-otd/${y}-golf-data.json`);
                                if (jRes.ok) {
                                    const parsed = normalizeEvents(await jRes.json(), y);
                                    allEvents = allEvents.concat(parsed.events);
                                    allNames = { ...allNames, ...parsed.names };
                                    loadedAny = true;
                                }
                            } catch (e) { /* Skip missing files silently */ }
                        }
                    } catch (e) {
                        console.log("Auto-fetch blocked or failed, waiting for user upload.");
                    }

                    if (loadedAny && allEvents.length > 0) {
                        setEvents(deduplicateEvents(allEvents));
                        setGolferNames(allNames);
                        setDataLoaded(true);
                    }
                    setIsLoading(false);
                };

                attemptAutoFetch();
            }, []);

            const handleFiles = async (e) => {
                setIsLoading(true);
                const files = Array.from(e.target.files);
                let newEvents = [];
                let newNames = {};
                
                for (let file of files) {
                    if (file.name.toLowerCase().endsWith('.json')) {
                        try {
                            const json = JSON.parse(await file.text());
                            const yearMatch = file.name.match(/(\d{4})/);
                            const year = yearMatch ? parseInt(yearMatch[1]) : null;
                            const parsed = normalizeEvents(json, year);
                            newEvents = newEvents.concat(parsed.events);
                            newNames = { ...newNames, ...parsed.names };
                        } catch(err) { console.error("Error parsing", file.name) }
                    }
                }
                
                setEvents(prev => deduplicateEvents([...prev, ...newEvents]));
                setGolferNames(prev => ({...prev, ...newNames}));
                setDataLoaded(true);
                setIsLoading(false);
            };

            const getDisplayName = (gId) => {
                if (golferNames[gId]) return golferNames[gId];
                return /^\d+$/.test(gId) ? `Golfer ID: ${gId}` : gId;
            };

            // Aggregate data by year
            const yearGroups = useMemo(() => {
                const groups = {};
                events.forEach(e => {
                    if (!groups[e.year]) groups[e.year] = { total: 0, golfers: {} };
                    groups[e.year].total += e.rax;
                    if (!groups[e.year].golfers[e.golferId]) groups[e.year].golfers[e.golferId] = 0;
                    groups[e.year].golfers[e.golferId] += e.rax;
                });
                return groups;
            }, [events]);
            
            const sortedYears = Object.keys(yearGroups).sort((a,b) => b - a);

            // Aggregate data globally for "Best Investments"
            const golferAggregates = useMemo(() => {
                const groups = {};
                events.forEach(e => {
                    if (!groups[e.golferId]) groups[e.golferId] = { total: 0, years: {} };
                    groups[e.golferId].total += e.rax;
                    groups[e.golferId].years[e.year] = (groups[e.golferId].years[e.year] || 0) + e.rax;
                });
                return groups;
            }, [events]);
            
            const sortedTopGolfers = Object.keys(golferAggregates).sort((a,b) => golferAggregates[b].total - golferAggregates[a].total);

            // Calculate Best Individual Seasons (Golfer + Year combination)
            const topSeasons = useMemo(() => {
                const seasons = [];
                Object.keys(golferAggregates).forEach(gId => {
                    const yearsObj = golferAggregates[gId].years;
                    Object.keys(yearsObj).forEach(year => {
                        seasons.push({
                            golferId: gId,
                            year: year,
                            rax: yearsObj[year]
                        });
                    });
                });
                return seasons.sort((a, b) => b.rax - a.rax);
            }, [golferAggregates]);

            return (
                <div className="pb-24">
                    {/* Header */}
                    <header className="bg-gray-900/60 backdrop-blur-xl border-b border-gray-800 sticky top-0 z-50">
                        <div className="max-w-4xl mx-auto flex justify-between items-center p-5 px-6">
                            <h1 className="text-xl md:text-2xl font-black tracking-tight flex items-center gap-3 text-white">
                                <div className="p-2 bg-emerald-500/10 rounded-xl text-emerald-400">
                                    <CalendarIcon size={22} />
                                </div>
                                Golf Rax Tracker
                            </h1>
                            {dataLoaded && (
                                <div className="hidden sm:block text-xs font-bold text-emerald-400 bg-emerald-400/10 px-3 py-1.5 rounded-full border border-emerald-500/20 uppercase tracking-wider">
                                    {events.length.toLocaleString()} Records Active
                                </div>
                            )}
                        </div>
                    </header>
                    
                    <main className="max-w-4xl mx-auto mt-10 px-4 md:px-6">
                        {isLoading && !dataLoaded ? (
                            <div className="flex flex-col items-center justify-center p-20 text-gray-500 animate-pulse bg-gray-900/40 rounded-3xl border border-gray-800 backdrop-blur-sm">
                                <SearchIcon size={48} className="mb-4 opacity-50 animate-spin text-emerald-500" />
                                <p className="text-lg font-medium">Analyzing repository data...</p>
                            </div>
                        ) : !dataLoaded ? (
                            <div className="bg-gray-900/60 backdrop-blur-md p-10 md:p-16 rounded-3xl shadow-2xl border border-gray-800 text-center relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 to-blue-500"></div>
                                <div className="w-20 h-20 bg-gray-800 text-emerald-400 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner border border-gray-700">
                                    <UploadIcon size={36} />
                                </div>
                                <h2 className="text-3xl font-black mb-3 text-white tracking-tight">Load Rax Data</h2>
                                <p className="text-gray-400 mb-10 max-w-md mx-auto text-lg leading-relaxed">
                                    Automatic data fetching failed. Make sure your JSON files are located in a <b className="text-gray-300">public/golf-otd/</b> folder, or manually load them below.
                                </p>
                                
                                <label className="cursor-pointer bg-emerald-500 hover:bg-emerald-400 text-gray-950 px-8 py-4 rounded-xl font-bold inline-flex items-center gap-3 shadow-lg shadow-emerald-500/20 transition-all hover:scale-105 hover:-translate-y-1">
                                    <UploadIcon size={20} />
                                    Select Local Files
                                    <input type="file" multiple accept=".json" className="hidden" onChange={handleFiles} />
                                </label>
                            </div>
                        ) : (
                            <div className="animate-fade-in space-y-8">
                                
                                {/* View Mode Toggles */}
                                {events.length > 0 && (
                                    <div className="flex justify-center sticky top-[88px] z-40 pb-4">
                                        <div className="flex bg-gray-900/80 backdrop-blur-xl border border-gray-700/50 p-1.5 rounded-2xl shadow-xl overflow-x-auto max-w-full inline-flex mx-auto">
                                            <button 
                                                onClick={() => setViewMode('investments')}
                                                className={`whitespace-nowrap px-5 py-2.5 rounded-xl font-bold text-sm transition-all duration-300 flex-1 ${viewMode === 'investments' ? 'bg-emerald-500 text-gray-950 shadow-md shadow-emerald-500/20' : 'text-gray-400 hover:text-white hover:bg-gray-800/50'}`}>
                                                üèÜ All-Time Best
                                            </button>
                                            <button 
                                                onClick={() => setViewMode('seasons')}
                                                className={`whitespace-nowrap px-5 py-2.5 rounded-xl font-bold text-sm transition-all duration-300 flex-1 mx-1 ${viewMode === 'seasons' ? 'bg-emerald-500 text-gray-950 shadow-md shadow-emerald-500/20' : 'text-gray-400 hover:text-white hover:bg-gray-800/50'}`}>
                                                üéØ Top Seasons
                                            </button>
                                            <button 
                                                onClick={() => setViewMode('years')}
                                                className={`whitespace-nowrap px-5 py-2.5 rounded-xl font-bold text-sm transition-all duration-300 flex-1 ${viewMode === 'years' ? 'bg-emerald-500 text-gray-950 shadow-md shadow-emerald-500/20' : 'text-gray-400 hover:text-white hover:bg-gray-800/50'}`}>
                                                üìÖ By Year
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {/* Results Rendering */}
                                {sortedYears.length === 0 ? (
                                    <div className="text-center p-16 bg-gray-900/40 backdrop-blur-md rounded-3xl border border-gray-800 text-gray-500">
                                        <CalendarXIcon size={64} className="mx-auto mb-5 opacity-20" />
                                        <h3 className="text-2xl font-bold text-gray-300 tracking-tight">No Events Found</h3>
                                        <p className="mt-2 text-lg">There are no recorded earnings loaded yet.</p>
                                    </div>
                                ) : (
                                    <div className="space-y-8">
                                        {/* Best Seasons View */}
                                        {viewMode === 'seasons' && (
                                            <div className="bg-gray-900/60 backdrop-blur-sm rounded-3xl border border-gray-800 overflow-hidden shadow-2xl">
                                                <div className="bg-gradient-to-r from-gray-800/80 to-gray-900/80 px-6 md:px-8 py-5 border-b border-gray-700/50 flex justify-between items-center">
                                                    <h3 className="text-xl font-black text-gray-100 tracking-tight">Best Individual Seasons</h3>
                                                </div>
                                                <ul className="divide-y divide-gray-800/50">
                                                    {topSeasons.map((season, index) => (
                                                        <li key={`${season.golferId}-${season.year}`} className="px-6 md:px-8 py-5 flex flex-col sm:flex-row sm:justify-between sm:items-center hover:bg-gray-800/40 transition-all duration-200 group gap-4">
                                                            <div className="flex items-center gap-4">
                                                                <div className={`flex items-center justify-center min-w-[32px] h-8 rounded-full border text-sm font-bold transition-colors ${index < 3 ? 'bg-emerald-500/10 border-emerald-500/30 text-emerald-400' : 'bg-gray-800 border-gray-700 text-gray-400 group-hover:bg-gray-700'}`}>
                                                                    {index + 1}
                                                                </div>
                                                                <div className="flex flex-col sm:flex-row sm:items-center gap-1.5 sm:gap-4">
                                                                    <span className="font-bold text-gray-100 text-lg group-hover:text-white transition-colors">
                                                                        {getDisplayName(season.golferId)}
                                                                    </span>
                                                                    <span className="text-xs font-black bg-blue-500/10 text-blue-400 px-2.5 py-1 rounded-md border border-blue-500/20 uppercase tracking-wider w-max">
                                                                        {season.year} Season
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <div className="sm:text-right pl-12 sm:pl-0 flex items-baseline gap-1.5">
                                                                <span className="text-emerald-400 font-black text-2xl tracking-tighter">
                                                                    {season.rax.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 1 })}
                                                                </span>
                                                                <span className="text-sm font-bold text-gray-500 uppercase tracking-widest">Rax</span>
                                                            </div>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}

                                        {/* All-Time Best View */}
                                        {viewMode === 'investments' && (
                                            <div className="bg-gray-900/60 backdrop-blur-sm rounded-3xl border border-gray-800 overflow-hidden shadow-2xl">
                                                <div className="bg-gradient-to-r from-gray-800/80 to-gray-900/80 px-6 md:px-8 py-5 border-b border-gray-700/50 flex justify-between items-center">
                                                    <h3 className="text-xl font-black text-gray-100 tracking-tight">Top Earners Across All Years</h3>
                                                </div>
                                                <ul className="divide-y divide-gray-800/50">
                                                    {sortedTopGolfers.map((gId, index) => {
                                                        const data = golferAggregates[gId];
                                                        const activeYears = Object.keys(data.years).sort((a,b) => b-a);
                                                        return (
                                                            <li key={gId} className="px-6 md:px-8 py-5 flex flex-col sm:flex-row sm:justify-between sm:items-center hover:bg-gray-800/40 transition-all duration-200 group gap-4">
                                                                <div className="flex items-start sm:items-center gap-4">
                                                                    <div className={`flex items-center justify-center min-w-[32px] h-8 rounded-full border text-sm font-bold mt-1 sm:mt-0 transition-colors ${index < 3 ? 'bg-emerald-500/10 border-emerald-500/30 text-emerald-400' : 'bg-gray-800 border-gray-700 text-gray-400 group-hover:bg-gray-700'}`}>
                                                                        {index + 1}
                                                                    </div>
                                                                    <div>
                                                                        <div className="font-bold text-gray-100 text-lg group-hover:text-white transition-colors">
                                                                            {getDisplayName(gId)}
                                                                        </div>
                                                                        <div className="text-xs text-gray-400 mt-1.5 font-medium flex items-center gap-2">
                                                                            <span className="bg-gray-800 px-2 py-0.5 rounded-md border border-gray-700 font-bold text-gray-300">
                                                                                {activeYears.length} {activeYears.length === 1 ? 'Year' : 'Years'}
                                                                            </span>
                                                                            <span className="truncate max-w-[150px] sm:max-w-[250px] opacity-70">
                                                                                ({activeYears.join(', ')})
                                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div className="sm:text-right pl-12 sm:pl-0 flex items-baseline gap-1.5">
                                                                    <span className="text-emerald-400 font-black text-2xl tracking-tighter">
                                                                        {data.total.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 1 })}
                                                                    </span>
                                                                    <span className="text-sm font-bold text-gray-500 uppercase tracking-widest">Rax</span>
                                                                </div>
                                                            </li>
                                                        );
                                                    })}
                                                </ul>
                                            </div>
                                        )}

                                        {/* Year-by-Year View */}
                                        {viewMode === 'years' && sortedYears.map(year => {
                                            const data = yearGroups[year];
                                            const sortedGolfers = Object.keys(data.golfers).sort((a,b) => data.golfers[b] - data.golfers[a]);
                                            const maxRax = Math.max(...Object.values(data.golfers));
                                            
                                            return (
                                                <div key={year} className="bg-gray-900/60 backdrop-blur-sm rounded-3xl border border-gray-800 overflow-hidden shadow-xl">
                                                    <div className="bg-gradient-to-r from-gray-800/80 to-gray-900/80 px-6 md:px-8 py-5 border-b border-gray-700/50 flex justify-between items-center">
                                                        <h3 className="text-2xl font-black text-white tracking-tight">{year}</h3>
                                                        <div className="flex flex-col items-end">
                                                            <span className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-0.5">Year Total</span>
                                                            <span className="font-black text-emerald-400 text-lg tracking-tight">
                                                                {data.total.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 1 })} <span className="text-sm opacity-70 font-semibold">RAX</span>
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <ul className="divide-y divide-gray-800/50">
                                                        {sortedGolfers.map((gId, index) => (
                                                            <li key={gId} className="px-6 md:px-8 py-4 flex justify-between items-center hover:bg-gray-800/40 transition-colors group">
                                                                <div className="flex items-center gap-4">
                                                                    <div className="flex items-center justify-center min-w-[28px] h-7 rounded-full bg-gray-800 border border-gray-700 text-xs font-bold text-gray-400 group-hover:bg-gray-700 transition-colors">
                                                                        {index + 1}
                                                                    </div>
                                                                    <div className="flex items-center gap-3">
                                                                        <span className="font-semibold text-gray-200 text-lg group-hover:text-white transition-colors">
                                                                            {getDisplayName(gId)}
                                                                        </span>
                                                                        {data.golfers[gId] === maxRax && (
                                                                            <span className="hidden sm:inline-block text-[10px] uppercase tracking-widest bg-emerald-500/10 text-emerald-400 px-2 py-0.5 rounded-md font-bold border border-emerald-500/20">
                                                                                Top Earner
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                <div className="text-right flex items-baseline gap-1.5">
                                                                    <span className="text-gray-100 font-bold text-xl tracking-tight">
                                                                        {data.golfers[gId].toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 1 })}
                                                                    </span>
                                                                </div>
                                                            </li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
